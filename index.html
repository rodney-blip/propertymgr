<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auction Property Analyzer - Dashboard</title>
    <style>
        :root {
            --bg-gradient-start: #667eea;
            --bg-gradient-end: #764ba2;
            --card-bg: #ffffff;
            --card-text: #333333;
            --card-text-secondary: #666666;
            --card-text-muted: #888888;
            --card-border: #e0e0e0;
            --card-hover-border: #667eea;
            --recommended-bg: #f1f8f4;
            --recommended-border: #4caf50;
            --header-bg: #ffffff;
            --header-title: #667eea;
            --header-subtitle: #666666;
            --stat-value: #333333;
            --input-bg: #ffffff;
            --input-border: #e0e0e0;
            --input-focus-border: #667eea;
            --dropdown-bg: #ffffff;
            --dropdown-hover: #f0f0ff;
            --section-heading: #333333;
            --divider: #e0e0e0;
            --accent: #667eea;
            --accent-secondary: #764ba2;
            --profit-green: #4caf50;
            --danger-red: #ff6b6b;
            --progress-bg: #e0e0e0;
            --link-color: #667eea;
            --badge-bg: #667eea;
            --shadow: rgba(0,0,0,0.1);
            --shadow-heavy: rgba(0,0,0,0.2);
            --chart-bar-start: #667eea;
            --chart-bar-end: #764ba2;
            --chart-label: #555555;
            --modal-backdrop: rgba(0,0,0,0.5);
            --comparison-bar-bg: #1e293b;
            --note-bg: #fafafa;
            --note-border: #e0e0e0;
        }

        body.dark {
            --bg-gradient-start: #0f172a;
            --bg-gradient-end: #1e293b;
            --card-bg: #1e293b;
            --card-text: #e2e8f0;
            --card-text-secondary: #94a3b8;
            --card-text-muted: #64748b;
            --card-border: #334155;
            --card-hover-border: #667eea;
            --recommended-bg: #1a2e1a;
            --recommended-border: #2e7d32;
            --header-bg: #1e293b;
            --header-title: #818cf8;
            --header-subtitle: #94a3b8;
            --stat-value: #e2e8f0;
            --input-bg: #0f172a;
            --input-border: #334155;
            --input-focus-border: #667eea;
            --dropdown-bg: #1e293b;
            --dropdown-hover: #334155;
            --section-heading: #e2e8f0;
            --divider: #334155;
            --accent: #818cf8;
            --accent-secondary: #a78bfa;
            --profit-green: #4ade80;
            --danger-red: #f87171;
            --progress-bg: #334155;
            --link-color: #818cf8;
            --badge-bg: #667eea;
            --shadow: rgba(0,0,0,0.3);
            --shadow-heavy: rgba(0,0,0,0.5);
            --chart-bar-start: #818cf8;
            --chart-bar-end: #a78bfa;
            --chart-label: #94a3b8;
            --modal-backdrop: rgba(0,0,0,0.7);
            --comparison-bar-bg: #0f172a;
            --note-bg: #0f172a;
            --note-border: #334155;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            padding: 20px;
            min-height: 100vh;
            color: var(--card-text);
            transition: background 0.3s, color 0.3s;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: var(--header-bg);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px var(--shadow-heavy);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-left {
            flex: 1;
        }

        .header h1 {
            color: var(--header-title);
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: var(--header-subtitle);
            font-size: 1.1em;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-shrink: 0;
        }

        .notes-indicator {
            color: var(--card-text-secondary);
            font-size: 0.9em;
            font-weight: 600;
        }

        .dark-mode-toggle {
            background: var(--card-border);
            border: none;
            width: 50px;
            height: 28px;
            border-radius: 14px;
            cursor: pointer;
            position: relative;
            transition: background 0.3s;
            padding: 0;
        }

        .dark-mode-toggle::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: white;
            transition: transform 0.3s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        body.dark .dark-mode-toggle {
            background: #667eea;
        }

        body.dark .dark-mode-toggle::after {
            transform: translateX(22px);
        }

        .dark-mode-label {
            font-size: 0.85em;
            color: var(--card-text-secondary);
            cursor: pointer;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px var(--shadow);
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card .label {
            color: var(--card-text-muted);
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            color: var(--stat-value);
            font-size: 2em;
            font-weight: bold;
        }

        .stat-card.highlight .value {
            color: var(--accent);
        }

        /* Data disclaimer banner */
        .data-disclaimer {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            background: linear-gradient(135deg, #fff3cd, #ffeeba);
            border: 1px solid #f0c36d;
            border-radius: 10px;
            padding: 16px 20px;
            margin-bottom: 20px;
            font-size: 0.9em;
            line-height: 1.5;
        }

        .dark .data-disclaimer {
            background: linear-gradient(135deg, #3d3520, #4a3f25);
            border-color: #6b5a2e;
        }

        .disclaimer-icon {
            font-size: 1.4em;
            flex-shrink: 0;
            margin-top: 1px;
        }

        .disclaimer-text {
            color: #856404;
        }

        .dark .disclaimer-text {
            color: #f0c36d;
        }

        .methodology-content a {
            color: var(--accent, #667eea);
            text-decoration: none;
        }

        .methodology-content a:hover {
            text-decoration: underline;
        }

        /* Charts section */
        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px var(--shadow);
        }

        .chart-card h3 {
            color: var(--section-heading);
            margin-bottom: 20px;
            font-size: 1.1em;
        }

        .methodology-content {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .method-block h4 {
            color: var(--accent);
            font-size: 0.95em;
            margin: 0 0 6px 0;
            letter-spacing: 0.3px;
        }

        .method-block p {
            color: var(--text-secondary, #666);
            font-size: 0.88em;
            line-height: 1.55;
            margin: 0;
        }

        .method-block code {
            background: var(--hover-bg, rgba(102,126,234,0.08));
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.92em;
            color: var(--text-primary, #333);
            white-space: nowrap;
        }

        @media (max-width: 768px) {
            .method-block code {
                white-space: normal;
            }
        }

        .chart-container {
            width: 100%;
            overflow: visible;
        }

        .alerts-section {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px var(--shadow);
            margin-bottom: 30px;
        }

        .alerts-section h2 {
            color: var(--section-heading);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-item {
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
        }

        .alert-item:hover {
            transform: scale(1.02);
        }

        .alert-item.excellent {
            background: linear-gradient(135deg, #f093fb, #f5576c);
        }

        .alert-item.good {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
        }

        .alert-dismiss {
            position: absolute;
            top: 10px;
            right: 12px;
            background: rgba(255,255,255,0.25);
            border: none;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 18px;
            line-height: 26px;
            text-align: center;
            cursor: pointer;
            transition: background 0.2s;
            padding: 0;
        }

        .alert-dismiss:hover {
            background: rgba(255,255,255,0.5);
        }

        .alert-level {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 6px;
        }

        .alert-address {
            margin-bottom: 4px;
        }

        .alert-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .alert-cta {
            margin-top: 10px;
            font-size: 0.85em;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .alert-item:hover .alert-cta {
            opacity: 0.8;
        }

        .alerts-empty {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary, #888);
            font-size: 0.95em;
        }

        .restore-alerts-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            margin-left: 10px;
            transition: opacity 0.2s;
        }

        .restore-alerts-btn:hover {
            opacity: 0.85;
        }

        .alerts-toggle {
            background: none;
            border: 2px solid rgba(255,255,255,0.3);
            color: var(--card-text-secondary);
            padding: 8px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 10px;
            margin-right: 8px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .alerts-toggle:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            transform: translateY(-1px);
        }

        .filters {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px var(--shadow);
            margin-bottom: 30px;
        }

        .filters h3 {
            color: var(--section-heading);
            margin-bottom: 20px;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            color: var(--card-text-secondary);
            font-size: 0.9em;
            font-weight: 600;
        }

        .filter-group select,
        .filter-group input {
            padding: 10px;
            border: 2px solid var(--input-border);
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.2s;
            background: var(--input-bg);
            color: var(--card-text);
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: var(--input-focus-border);
        }

        .search-input {
            padding: 10px 10px 10px 36px;
            border: 2px solid var(--input-border);
            border-radius: 8px;
            font-size: 1em;
            width: 100%;
            transition: border-color 0.2s;
            background: var(--input-bg);
            color: var(--card-text);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--input-focus-border);
        }

        .search-wrapper {
            position: relative;
        }

        .search-wrapper::before {
            content: '\1F50D';
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1em;
            pointer-events: none;
        }

        /* Price range slider */
        .range-slider-container {
            position: relative;
            height: 36px;
            display: flex;
            align-items: center;
        }
        .range-slider-container input[type="range"] {
            position: absolute;
            width: 100%;
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            background: transparent;
            pointer-events: none;
        }
        .range-slider-container input[type="range"]:first-child {
            background: linear-gradient(90deg, var(--input-border), var(--accent));
            border-radius: 3px;
        }
        .range-slider-container input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 22px;
            width: 22px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            pointer-events: all;
            border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        .range-slider-container input[type="range"]::-moz-range-thumb {
            height: 22px;
            width: 22px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            pointer-events: all;
            border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        .range-display {
            text-align: center;
            font-weight: 600;
            color: var(--card-text);
            font-size: 0.95em;
            margin-top: 2px;
        }

        /* Multi-select region dropdown */
        .multi-select {
            position: relative;
        }
        .multi-select-trigger {
            padding: 10px;
            border: 2px solid var(--input-border);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--input-bg);
            font-size: 1em;
            transition: border-color 0.2s;
            user-select: none;
            color: var(--card-text);
        }
        .multi-select-trigger:hover {
            border-color: var(--accent);
        }
        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--dropdown-bg);
            border: 2px solid var(--accent);
            border-radius: 8px;
            margin-top: 4px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 5px 15px var(--shadow);
        }
        .multi-select-options label {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            cursor: pointer;
            gap: 8px;
            font-size: 0.95em;
            color: var(--card-text);
        }
        .multi-select-options label:hover {
            background: var(--dropdown-hover);
        }
        .multi-select-options .region-group-header {
            font-weight: 700;
            color: var(--accent);
            padding: 8px 12px 4px;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .multi-select-options hr {
            margin: 4px 0;
            border: none;
            border-top: 1px solid var(--divider);
        }

        /* Status select */
        .status-select {
            padding: 5px 8px;
            border-radius: 6px;
            border: 2px solid var(--input-border);
            font-size: 0.8em;
            cursor: pointer;
            background: var(--input-bg);
            color: var(--card-text);
            flex-shrink: 0;
        }
        .status-select.interested {
            border-color: #4caf50;
            background: #f1f8f4;
            color: #2e7d32;
        }
        .status-select.not-interested {
            border-color: #ff6b6b;
            background: #fff5f5;
            color: #c62828;
        }
        body.dark .status-select.interested {
            background: #1a2e1a;
            color: #4ade80;
        }
        body.dark .status-select.not-interested {
            background: #2e1a1a;
            color: #f87171;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .properties-section {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px var(--shadow);
        }

        .properties-section h2 {
            color: var(--section-heading);
            margin-bottom: 20px;
        }

        .property-card {
            border: 2px solid var(--card-border);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s;
            background: var(--card-bg);
        }

        .property-card:hover {
            border-color: var(--card-hover-border);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.2);
        }

        .property-card.recommended {
            border-color: var(--recommended-border);
            background: var(--recommended-bg);
        }

        .property-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
            gap: 10px;
        }

        .compare-checkbox {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--accent);
            flex-shrink: 0;
            margin-top: 4px;
        }

        .property-address {
            flex: 1;
        }

        .property-address h3 {
            color: var(--card-text);
            margin-bottom: 5px;
        }

        .property-address p {
            color: var(--card-text-secondary);
            font-size: 0.9em;
        }

        .deal-badge {
            background: var(--badge-bg);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
            flex-shrink: 0;
        }

        .deal-badge.hot {
            background: #ff6b6b;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .property-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .metric {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .metric-label {
            color: var(--card-text-muted);
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-value {
            color: var(--card-text);
            font-size: 1.1em;
            font-weight: bold;
        }

        .metric-value.profit {
            color: var(--profit-green);
            font-size: 1.3em;
        }

        .metric-value.max-bid {
            font-size: 1.2em;
            font-weight: 700;
        }

        .metric-value.under-max {
            color: var(--profit-green, #27ae60);
        }

        .metric-value.over-max {
            color: #e74c3c;
        }

        .property-details {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            padding-top: 15px;
            border-top: 1px solid var(--divider);
            color: var(--card-text-secondary);
            font-size: 0.9em;
        }

        .detail-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .detail-item a {
            color: var(--link-color);
            text-decoration: none;
            font-weight: 600;
        }
        .detail-item a:hover {
            text-decoration: underline;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--progress-bg);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent-secondary));
            transition: width 0.3s;
        }

        .extra-data-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            padding-top: 10px;
            margin-top: 10px;
            border-top: 1px solid var(--divider);
            color: var(--card-text-secondary);
            font-size: 0.9em;
        }

        .property-notes {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--divider);
        }

        .property-notes textarea {
            width: 100%;
            min-height: 60px;
            padding: 10px;
            border: 2px solid var(--note-border);
            border-radius: 8px;
            background: var(--note-bg);
            color: var(--card-text);
            font-family: inherit;
            font-size: 0.9em;
            resize: vertical;
            transition: border-color 0.2s;
        }

        .property-notes textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .property-notes label {
            display: block;
            font-size: 0.85em;
            color: var(--card-text-muted);
            margin-bottom: 6px;
            font-weight: 600;
        }

        .auction-countdown {
            font-weight: bold;
        }

        .auction-countdown.urgent {
            color: #dc2626;
            font-weight: 900;
        }

        .auction-countdown.soon {
            color: #d97706;
            font-weight: 900;
        }

        .auction-countdown.passed {
            color: #dc2626;
            font-style: italic;
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: var(--card-text-muted);
        }

        .no-results h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #38bdf8, #3b82f6);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--card-text-secondary);
        }

        /* Comparison floating bar */
        .comparison-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--comparison-bar-bg);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            z-index: 500;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .comparison-bar.visible {
            transform: translateY(0);
        }

        .comparison-bar span {
            font-weight: 600;
        }

        .comparison-bar button {
            padding: 10px 20px;
            font-size: 0.95em;
        }

        .comparison-bar .btn-clear {
            background: #475569;
        }

        /* Comparison modal */
        .comparison-modal-backdrop {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--modal-backdrop);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .comparison-modal {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 30px;
            max-width: 95vw;
            max-height: 85vh;
            overflow: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
        }

        .comparison-modal h2 {
            color: var(--section-heading);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .comparison-modal .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: var(--card-text-muted);
            padding: 5px 10px;
        }

        .comparison-modal .close-btn:hover {
            color: var(--card-text);
            transform: none;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95em;
        }

        .comparison-table th {
            text-align: left;
            padding: 10px 12px;
            background: var(--dropdown-hover);
            color: var(--card-text-muted);
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--divider);
            position: sticky;
            top: 0;
        }

        .comparison-table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--divider);
            color: var(--card-text);
        }

        .comparison-table tr:hover td {
            background: var(--dropdown-hover);
        }

        .comparison-table .metric-name {
            font-weight: 600;
            color: var(--card-text-secondary);
            min-width: 140px;
        }

        .comparison-table .best-value {
            color: var(--profit-green);
            font-weight: 700;
        }

        @media (max-width: 768px) {
            .header h1 { font-size: 1.8em; }
            .charts-section { grid-template-columns: 1fr; }
            .comparison-modal { padding: 20px; }
            .filter-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Password gate -->
    <div id="authGate" style="position:fixed; inset:0; z-index:9999; background:var(--bg, #f5f7fa); display:flex; align-items:center; justify-content:center;">
        <div style="background:var(--card-bg, #fff); padding:40px 36px; border-radius:16px; box-shadow:0 10px 40px rgba(0,0,0,0.15); text-align:center; max-width:360px; width:90%;">
            <div style="font-size:2.5em; margin-bottom:12px;">&#x1F3E0;</div>
            <h2 style="margin:0 0 6px; color:var(--text-primary, #333);">Property Analyzer</h2>
            <p style="margin:0 0 24px; color:var(--text-secondary, #888); font-size:0.9em;">Enter password to continue</p>
            <input type="password" id="authPassword" placeholder="Password"
                   style="width:100%; padding:12px 16px; border:2px solid var(--divider, #ddd); border-radius:8px; font-size:1em; box-sizing:border-box; outline:none; background:var(--bg, #f5f7fa); color:var(--text-primary, #333);"
                   onkeydown="if(event.key==='Enter')checkAuth()">
            <button onclick="checkAuth()"
                    style="width:100%; margin-top:12px; padding:12px; background:linear-gradient(135deg, #667eea, #764ba2); color:white; border:none; border-radius:8px; font-size:1em; font-weight:600; cursor:pointer;">
                Unlock
            </button>
            <p id="authError" style="color:#e74c3c; margin:12px 0 0; font-size:0.85em; display:none;">Incorrect password</p>
        </div>
    </div>

    <script>
        // Simple password gate — keeps casual visitors out.
        // Change this value to set your password:
        var AUTH_PASSWORD = 'deals2026';

        function checkAuth() {
            var input = document.getElementById('authPassword').value;
            if (input === AUTH_PASSWORD) {
                sessionStorage.setItem('authed', '1');
                document.getElementById('authGate').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                // initApp is defined later in the page; call it if available
                if (typeof initApp === 'function') initApp();
            } else {
                document.getElementById('authError').style.display = 'block';
                document.getElementById('authPassword').value = '';
                document.getElementById('authPassword').focus();
            }
        }

        // Check if already authenticated this session
        if (sessionStorage.getItem('authed') === '1') {
            document.getElementById('authGate').style.display = 'none';
        } else {
            document.getElementById('authGate').style.display = 'flex';
        }
    </script>

    <div id="mainContent" style="display:none;">
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>&#x1F3E0; Auction Property Analyzer</h1>
                <p>Fix-and-Flip Deal Finder | OR &bull; TX &bull; WA</p>
            </div>
            <div class="header-right">
                <span class="notes-indicator" id="notesIndicator" style="display:none;"></span>
                <span class="dark-mode-label" onclick="toggleDarkMode()">Dark</span>
                <button class="dark-mode-toggle" onclick="toggleDarkMode()" title="Toggle dark mode"></button>
            </div>
        </div>

        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="label">Total Properties</div>
                <div class="value" id="totalProperties">-</div>
            </div>
            <div class="stat-card highlight">
                <div class="label">Recommended Deals</div>
                <div class="value" id="recommendedDeals">-</div>
            </div>
            <div class="stat-card">
                <div class="label">Avg Profit Margin</div>
                <div class="value" id="avgMargin">-</div>
            </div>
            <div class="stat-card">
                <div class="label">Hot Deals (40%+)</div>
                <div class="value" id="hotDeals">-</div>
            </div>
        </div>

        <div class="data-disclaimer" id="dataDisclaimer" style="display:none;">
            <div class="disclaimer-icon">&#x26A0;&#xFE0F;</div>
            <div class="disclaimer-text">
                <strong>Important: These are NOT confirmed auction listings.</strong>
                Properties are sourced from ATTOM public records (recent sales, assessments). Auction dates, foreclosure stages, lender names, and debt amounts are <strong>modeled estimates</strong> &mdash; not live filings. Use this dashboard to identify neighborhoods and price points, then verify actual auction status through the links below.
            </div>
        </div>

        <div class="charts-section" id="chartsSection" style="display:none;">
            <div class="chart-card methodology-card">
                <h3>&#x1F4D0; How Numbers Are Calculated</h3>
                <div class="methodology-content">
                    <div class="method-block">
                        <h4>Data Source &amp; Limitations</h4>
                        <p>Properties come from <strong>ATTOM public records</strong> (sale snapshots + property details) and <strong>BatchData</strong> (pre-foreclosure filings). On the current free/sandbox tier, ATTOM returns real addresses, sale prices, sq ft, beds/baths, and year built &mdash; but does <strong>not</strong> return seller names, foreclosure flags, or mortgage data. As a result:</p>
                        <ul style="margin: 6px 0 0 18px; font-size: 0.88em; line-height: 1.55; color: var(--text-secondary, #666);">
                            <li><strong>Auction dates</strong> are projected 14-60 days out (not from real auction schedules)</li>
                            <li><strong>Foreclosing entity, loan type, stage</strong> are modeled from typical market distributions</li>
                            <li><strong>Total debt</strong> is estimated at 70-95% of ARV (not from actual lien records)</li>
                        </ul>
                        <p style="margin-top: 8px;">Upgrading to ATTOM's paid tier ($100-250/mo) or a production BatchData key unlocks real foreclosure filings, mortgage amounts, and seller data.</p>
                    </div>
                    <div class="method-block">
                        <h4>ARV (After-Repair Value)</h4>
                        <p>Sourced from ATTOM's <strong>AVM (Automated Valuation Model)</strong> when available. If the API returns an assessed or market value, we apply a 1.1x markup to approximate post-repair ARV. When no API value exists, ARV is estimated from <strong>$/sq ft for the state</strong> (e.g. OR&nbsp;$200, TX&nbsp;$160, WA&nbsp;$230) multiplied by the property's living area.</p>
                    </div>
                    <div class="method-block">
                        <h4>Estimated Repairs</h4>
                        <p>Calculated as a <strong>percentage of last sale price</strong> based on building age: 20% for homes 40+ yrs old, 15% for 25-40 yrs, 10% for 10-25 yrs, and 5% for newer builds. This is a conservative desk estimate &mdash; always get a contractor walkthrough before committing.</p>
                    </div>
                    <div class="method-block">
                        <h4>Max Bid Price (91% Rule)</h4>
                        <p>Based on the <strong>70% rule</strong> with a 91% safety cushion:<br>
                        <code>Step 1: 70% Base = ARV &times; 0.70 &minus; Repairs</code><br>
                        <code>Step 2: Max Bid = 70% Base &times; 0.91</code><br>
                        This gives you a ~9% bidding cushion below the standard 70% rule. If the listed price is <strong style="color:var(--profit-green, #27ae60);">at or below</strong> the max bid, the deal has room; if it's <strong style="color:#e74c3c;">above</strong>, you'd be overpaying relative to the rule.</p>
                    </div>
                    <div class="method-block">
                        <h4>Profit Formula</h4>
                        <p><code>Total Investment = Purchase Price + Repairs + Closing (3%) + Holding (ARV &times; 1% &times; 6 mo)</code><br>
                        <code>Profit = ARV &minus; Total Investment &minus; Selling Costs (ARV &times; 8%)</code><br>
                        Recommended thresholds: margin &ge; 30%, repairs &le; $80k, deal score &ge; 60.</p>
                    </div>
                </div>
            </div>
            <div class="chart-card">
                <h3>&#x1F50D; Find Real Auctions</h3>
                <div class="methodology-content">
                    <div class="method-block">
                        <h4>Oregon</h4>
                        <p>
                            <a href="https://www.auction.com/residential/or/" target="_blank" rel="noopener">Auction.com &mdash; Oregon</a><br>
                            <a href="https://www.oregonsheriffs.org/foreclosure-sales" target="_blank" rel="noopener">Oregon Sheriff Sales</a><br>
                            <a href="https://www.deschutes.org/assessor/page/foreclosure-sales" target="_blank" rel="noopener">Deschutes County (Bend/Redmond)</a><br>
                            <a href="https://www.jacksoncounty.org" target="_blank" rel="noopener">Jackson County (Medford)</a>
                        </p>
                    </div>
                    <div class="method-block">
                        <h4>Texas</h4>
                        <p>
                            <a href="https://www.auction.com/residential/tx/" target="_blank" rel="noopener">Auction.com &mdash; Texas</a><br>
                            <a href="https://www.traviscountytx.gov/constables/5/sales" target="_blank" rel="noopener">Travis County (Austin) Constable Sales</a><br>
                            <a href="https://www.wilco.org/Departments/Constable-Precinct-1/Constable-Sales" target="_blank" rel="noopener">Williamson County (Round Rock/Georgetown)</a><br>
                            <a href="https://www.hubzu.com/search?state=TX" target="_blank" rel="noopener">Hubzu &mdash; Texas</a>
                        </p>
                    </div>
                    <div class="method-block">
                        <h4>Washington</h4>
                        <p>
                            <a href="https://www.auction.com/residential/wa/" target="_blank" rel="noopener">Auction.com &mdash; Washington</a><br>
                            <a href="https://www.clark.wa.gov/treasurer/foreclosure-sales" target="_blank" rel="noopener">Clark County (Vancouver) Treasurer Sales</a><br>
                            <a href="https://www.co.cowlitz.wa.us/352/Foreclosures" target="_blank" rel="noopener">Cowlitz County (Longview/Kelso)</a><br>
                            <a href="https://www.hubzu.com/search?state=WA" target="_blank" rel="noopener">Hubzu &mdash; Washington</a>
                        </p>
                    </div>
                    <div class="method-block">
                        <h4>National Search</h4>
                        <p>
                            <a href="https://www.auction.com" target="_blank" rel="noopener">Auction.com</a> &bull;
                            <a href="https://www.hubzu.com" target="_blank" rel="noopener">Hubzu</a> &bull;
                            <a href="https://www.xome.com" target="_blank" rel="noopener">Xome</a> &bull;
                            <a href="https://www.bid4assets.com" target="_blank" rel="noopener">Bid4Assets</a> &bull;
                            <a href="https://www.homepath.fanniemae.com" target="_blank" rel="noopener">HomePath (Fannie Mae)</a> &bull;
                            <a href="https://www.homesteps.com" target="_blank" rel="noopener">HomeSteps (Freddie Mac)</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="charts-section" id="stateChartSection" style="display:none;">
            <div class="chart-card">
                <h3>&#x1F4CD; Properties by State</h3>
                <div class="chart-container" id="stateChart"></div>
            </div>
        </div>

        <div class="alerts-section" id="alertsSection" style="display:none;">
            <h2>&#x1F6A8; High-Value Deal Alerts</h2>
            <div id="alertsContainer"></div>
            <button class="alerts-toggle" id="alertsToggle" style="display:none;" onclick="toggleAlerts()">Show All</button>
        </div>

        <div class="filters">
            <h3>&#x1F50D; Filter Properties</h3>
            <div class="filter-grid">
                <div class="filter-group">
                    <label>Search</label>
                    <div class="search-wrapper">
                        <input type="text" class="search-input" id="searchInput" placeholder="Address, city, ID, or entity..." oninput="handleSearchInput()">
                    </div>
                </div>
                <div class="filter-group">
                    <label>State</label>
                    <select id="stateFilter">
                    </select>
                </div>
                <div class="filter-group">
                    <label>Regions</label>
                    <div class="multi-select" id="regionMultiSelect">
                        <div class="multi-select-trigger" onclick="toggleRegionDropdown()">
                            <span id="regionSelectionText">All Regions</span>
                            <span>&#9662;</span>
                        </div>
                        <div class="multi-select-dropdown" id="regionDropdown" style="display:none;">
                            <div class="multi-select-options" id="regionOptions"></div>
                        </div>
                    </div>
                </div>
                <div class="filter-group">
                    <label>Price Range</label>
                    <div class="range-slider-container">
                        <input type="range" id="minPrice" min="0" max="2000000" step="100000" value="0" oninput="updatePriceRange()">
                        <input type="range" id="maxPrice" min="0" max="2000000" step="100000" value="2000000" oninput="updatePriceRange()">
                    </div>
                    <div class="range-display" id="priceRangeDisplay">$0 &ndash; $2.0M</div>
                </div>
                <div class="filter-group">
                    <label>Min Profit Margin (%)</label>
                    <input type="number" id="minMargin" value="0" min="0" max="100">
                </div>
                <div class="filter-group">
                    <label>Min Deal Score</label>
                    <input type="number" id="minScore" value="0" min="0" max="100">
                </div>
                <div class="filter-group">
                    <label>Sort By</label>
                    <select id="sortBy">
                        <option value="deal_score">Deal Score</option>
                        <option value="profit_margin">Profit Margin</option>
                        <option value="profit_potential">Profit Amount</option>
                        <option value="auction_date">Auction Date</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Review Status</label>
                    <select id="statusFilter">
                        <option value="all">All Statuses</option>
                        <option value="not_reviewed">Not Reviewed</option>
                        <option value="interested">Interested</option>
                        <option value="not_interested">Not Interested</option>
                    </select>
                </div>
                <div class="filter-group" style="display:flex; align-items:flex-end;">
                    <div class="filter-buttons">
                        <button onclick="applyFilters()">Apply Filters</button>
                        <button class="btn-secondary" onclick="exportCSV()">Export CSV</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="properties-section">
            <h2>&#x1F4CB; Property Listings (<span id="propertyCount">0</span>)</h2>
            <div id="propertiesContainer" class="loading">Loading properties...</div>
        </div>
    </div>

    <!-- Comparison floating bar -->
    <div class="comparison-bar" id="comparisonBar">
        <span id="comparisonCount">0 properties selected</span>
        <button onclick="openComparisonModal()">Compare</button>
        <button class="btn-clear" onclick="clearComparison()">Clear</button>
    </div>

    <script>
        let allProperties = [];
        let currentProperties = [];
        let selectedRegions = [];
        let allAlerts = [];
        let alertsExpanded = false;
        let comparisonSet = new Set();
        let searchDebounceTimer = null;

        const REGION_DEFINITIONS = {
            "Oregon": [
                "Portland Metro",
                "Salem / Mid-Valley",
                "Eugene / Lane County",
                "Central Oregon",
                "Southern Oregon"
            ],
            "Texas": [
                "Greater Austin",
                "Dallas / Fort Worth",
                "Houston Metro",
                "San Antonio Area",
                "El Paso Area"
            ],
            "Washington": [
                "Southern Washington / Vancouver"
            ],
            "Florida": [
                "Tampa Bay",
                "Orlando Metro",
                "Jacksonville"
            ],
            "Arizona": [
                "Phoenix Metro",
                "Tucson Area"
            ],
            "Georgia": [
                "Metro Atlanta",
                "Augusta / Savannah"
            ],
            "North Carolina": [
                "Charlotte Metro",
                "Raleigh-Durham"
            ],
            "Ohio": [
                "Columbus Metro",
                "Cleveland / Akron"
            ],
            "Tennessee": [
                "Nashville Metro",
                "Memphis Area"
            ],
            "California": [
                "Sacramento Metro",
                "Central Valley",
                "Inland Empire"
            ]
        };

        // Fallback URL mappings (used if JSON property_url is null)
        const PLATFORM_URLS = {
            "Auction.com": "https://www.auction.com",
            "Hubzu": "https://www.hubzu.com",
            "RealtyBid": "https://www.realtybid.com",
            "HomePath": "https://www.homepath.fanniemae.com",
            "Hudson & Marshall": "https://www.hudsonandmarshall.com",
            "Williams & Williams": "https://www.williamsauction.com",
            "Xome": "https://www.xome.com",
            "ServiceLink": "https://www.svclnk.com",
            "Foreclosure.com": "https://www.foreclosure.com",
            "RealtyTrac": "https://www.realtytrac.com",
            "Bid4Assets": "https://www.bid4assets.com",
            "ATTOM Sale": "https://www.zillow.com",
            "ATTOM Property": "https://www.zillow.com",
            "ATTOM Foreclosure": "https://www.zillow.com",
            "ATTOM REO": "https://www.zillow.com",
            "BatchData Pre-Foreclosure": "https://www.zillow.com"
        };

        const BANK_CONTACT_URLS = {
            "Bank of America": "https://realestatecenter.bankofamerica.com",
            "Wells Fargo": "https://reo.wellsfargo.com",
            "Chase Bank": "https://www.chase.com/personal/mortgage/reo",
            "US Bank": "https://www.usbank.com/home-loans/reo.html",
            "Citibank": "https://www.citibank.com/reo",
            "PNC Bank": "https://www.pnc.com/en/personal-banking/home-lending.html",
            "Truist Bank": "https://www.truist.com/mortgage/reo",
            "Capital One": "https://www.capitalone.com",
            "Flagstar Bank": "https://www.flagstar.com/reo",
            "Mr. Cooper": "https://www.mrcooper.com",
            "Nationstar Mortgage": "https://www.mrcooper.com",
            "Ocwen Financial": "https://www.phhmortgage.com",
            "PHH Mortgage": "https://www.phhmortgage.com",
            "Shellpoint Mortgage": "https://www.shellpointmtg.com",
            "Freedom Mortgage": "https://www.freedommortgage.com",
            "Caliber Home Loans": "https://www.newrez.com",
            "NewRez LLC": "https://www.newrez.com"
        };

        // ─── Dark mode ───
        function initDarkMode() {
            var saved = localStorage.getItem('darkMode');
            if (saved === 'true') {
                document.body.classList.add('dark');
            }
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark');
            localStorage.setItem('darkMode', document.body.classList.contains('dark'));
        }

        initDarkMode();

        // ─── Populate state dropdown dynamically ───
        function populateStateDropdown() {
            var select = document.getElementById('stateFilter');
            select.innerHTML = '<option value="all">All States</option>';
            Object.keys(REGION_DEFINITIONS).sort().forEach(function(state) {
                var opt = document.createElement('option');
                opt.value = state;
                opt.textContent = state;
                select.appendChild(opt);
            });
        }

        populateStateDropdown();

        // ─── localStorage status management ───
        const STATUS_KEY = 'propertyStatuses';
        const NOTES_KEY = 'propertyNotes';

        function getPropertyStatuses() {
            try { return JSON.parse(localStorage.getItem(STATUS_KEY)) || {}; }
            catch(e) { return {}; }
        }
        function setPropertyStatus(propId, status) {
            var statuses = getPropertyStatuses();
            if (status === 'not_reviewed') { delete statuses[propId]; }
            else { statuses[propId] = status; }
            localStorage.setItem(STATUS_KEY, JSON.stringify(statuses));
        }
        function getPropertyStatus(propId) {
            return getPropertyStatuses()[propId] || 'not_reviewed';
        }

        // ─── Dismissed alerts management ───
        const DISMISSED_ALERTS_KEY = 'dismissedAlerts';

        function getDismissedAlerts() {
            try { return JSON.parse(localStorage.getItem(DISMISSED_ALERTS_KEY)) || {}; }
            catch(e) { return {}; }
        }
        function dismissAlert(propId, event) {
            event.stopPropagation();
            var dismissed = getDismissedAlerts();
            dismissed[propId] = Date.now();
            localStorage.setItem(DISMISSED_ALERTS_KEY, JSON.stringify(dismissed));
            displayAlerts(allAlerts);
        }
        function restoreAllAlerts() {
            localStorage.removeItem(DISMISSED_ALERTS_KEY);
            displayAlerts(allAlerts);
        }

        // ─── Notes management ───
        function getPropertyNotes() {
            try { return JSON.parse(localStorage.getItem(NOTES_KEY)) || {}; }
            catch(e) { return {}; }
        }
        function setPropertyNote(propId, note) {
            var notes = getPropertyNotes();
            if (!note || note.trim() === '') { delete notes[propId]; }
            else { notes[propId] = note.trim(); }
            localStorage.setItem(NOTES_KEY, JSON.stringify(notes));
            updateNotesIndicator();
        }
        function getPropertyNote(propId) {
            return getPropertyNotes()[propId] || '';
        }
        function updateNotesIndicator() {
            var notes = getPropertyNotes();
            var count = Object.keys(notes).length;
            var indicator = document.getElementById('notesIndicator');
            if (count > 0) {
                indicator.textContent = '\u{1F4DD} ' + count + ' note' + (count !== 1 ? 's' : '');
                indicator.style.display = 'inline';
            } else {
                indicator.style.display = 'none';
            }
        }

        function handleNoteChange(textarea) {
            var propId = textarea.getAttribute('data-prop-id');
            setPropertyNote(propId, textarea.value);
        }

        // ─── Search debounce ───
        function handleSearchInput() {
            if (searchDebounceTimer) clearTimeout(searchDebounceTimer);
            searchDebounceTimer = setTimeout(function() {
                applyFilters();
            }, 300);
        }

        // ─── Price range slider ───
        function updatePriceRange() {
            var minEl = document.getElementById('minPrice');
            var maxEl = document.getElementById('maxPrice');
            var minVal = parseInt(minEl.value);
            var maxVal = parseInt(maxEl.value);
            if (minVal > maxVal) {
                var tmp = minVal; minVal = maxVal; maxVal = tmp;
                minEl.value = minVal;
                maxEl.value = maxVal;
            }
            function fmt(v) {
                if (v >= 1000000) return '$' + (v / 1000000).toFixed(1) + 'M';
                if (v > 0) return '$' + (v / 1000).toFixed(0) + 'K';
                return '$0';
            }
            document.getElementById('priceRangeDisplay').textContent = fmt(minVal) + ' \u2013 ' + fmt(maxVal);
        }

        // ─── Multi-select region dropdown ───
        function populateRegionCheckboxes() {
            var state = document.getElementById('stateFilter').value;
            var container = document.getElementById('regionOptions');
            container.innerHTML = '';

            // "All Regions" master checkbox
            var allLabel = document.createElement('label');
            allLabel.innerHTML = '<input type="checkbox" id="regionAll" checked onchange="toggleAllRegions(this)"> <strong>All Regions</strong>';
            container.appendChild(allLabel);
            var hr = document.createElement('hr');
            container.appendChild(hr);

            var states = state === 'all' ? Object.keys(REGION_DEFINITIONS).sort() : [state];
            states.forEach(function(st) {
                if (!REGION_DEFINITIONS[st]) return;
                if (states.length > 1) {
                    var header = document.createElement('div');
                    header.className = 'region-group-header';
                    header.textContent = st;
                    container.appendChild(header);
                }
                REGION_DEFINITIONS[st].forEach(function(region) {
                    var label = document.createElement('label');
                    label.innerHTML = '<input type="checkbox" value="' + region + '" class="region-cb" checked onchange="updateRegionSelection()"> ' + region;
                    container.appendChild(label);
                });
            });

            selectedRegions = [];
            updateRegionDisplayText();
        }

        function toggleAllRegions(masterCb) {
            var cbs = document.querySelectorAll('.region-cb');
            cbs.forEach(function(cb) { cb.checked = masterCb.checked; });
            updateRegionSelection();
        }

        function updateRegionSelection() {
            var checkboxes = document.querySelectorAll('.region-cb');
            var allChecked = Array.from(checkboxes).every(function(cb) { return cb.checked; });
            var noneChecked = Array.from(checkboxes).every(function(cb) { return !cb.checked; });
            document.getElementById('regionAll').checked = allChecked;
            if (allChecked || noneChecked) {
                selectedRegions = [];
            } else {
                selectedRegions = Array.from(checkboxes).filter(function(cb) { return cb.checked; }).map(function(cb) { return cb.value; });
            }
            updateRegionDisplayText();
        }

        function updateRegionDisplayText() {
            var text = document.getElementById('regionSelectionText');
            if (selectedRegions.length === 0) {
                text.textContent = 'All Regions';
            } else if (selectedRegions.length <= 2) {
                text.textContent = selectedRegions.join(', ');
            } else {
                text.textContent = selectedRegions.length + ' regions selected';
            }
        }

        function toggleRegionDropdown() {
            var dd = document.getElementById('regionDropdown');
            dd.style.display = dd.style.display === 'none' ? 'block' : 'none';
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('#regionMultiSelect')) {
                document.getElementById('regionDropdown').style.display = 'none';
            }
        });

        // State filter change repopulates regions
        document.getElementById('stateFilter').addEventListener('change', function() {
            populateRegionCheckboxes();
        });

        // Initialize region checkboxes
        populateRegionCheckboxes();

        // ─── Status change handler ───
        function handleStatusChange(selectEl) {
            var propId = selectEl.getAttribute('data-prop-id');
            var status = selectEl.value;
            setPropertyStatus(propId, status);
            selectEl.className = 'status-select';
            if (status === 'interested') selectEl.classList.add('interested');
            if (status === 'not_interested') selectEl.classList.add('not-interested');
        }

        // ─── Comparison mode ───
        function toggleCompare(checkbox, propId) {
            if (checkbox.checked) {
                if (comparisonSet.size >= 4) {
                    checkbox.checked = false;
                    return;
                }
                comparisonSet.add(propId);
            } else {
                comparisonSet.delete(propId);
            }
            updateComparisonBar();
        }

        function updateComparisonBar() {
            var bar = document.getElementById('comparisonBar');
            var countEl = document.getElementById('comparisonCount');
            if (comparisonSet.size >= 2) {
                bar.classList.add('visible');
                countEl.textContent = comparisonSet.size + ' properties selected';
            } else {
                bar.classList.remove('visible');
                countEl.textContent = comparisonSet.size + ' properties selected';
            }
        }

        function clearComparison() {
            comparisonSet.clear();
            document.querySelectorAll('.compare-checkbox').forEach(function(cb) { cb.checked = false; });
            updateComparisonBar();
        }

        function openComparisonModal() {
            if (comparisonSet.size < 2) return;
            var props = allProperties.filter(function(p) { return comparisonSet.has(p.id); });

            var metrics = [
                { label: 'Address', fn: function(p) { return p.address; } },
                { label: 'City, State', fn: function(p) { return p.city + ', ' + p.state; } },
                { label: 'Auction Price', fn: function(p) { return '$' + p.auction_price.toLocaleString(); }, compare: 'low' },
                { label: 'Est. ARV', fn: function(p) { return '$' + p.estimated_arv.toLocaleString(); }, compare: 'high' },
                { label: 'Est. Repairs', fn: function(p) { return '$' + p.estimated_repairs.toLocaleString(); }, compare: 'low' },
                { label: 'Profit', fn: function(p) { return '$' + p.profit_potential.toLocaleString(); }, compare: 'high' },
                { label: 'Profit Margin', fn: function(p) { return p.profit_margin.toFixed(1) + '%'; }, compare: 'high', rawFn: function(p) { return p.profit_margin; } },
                { label: 'Deal Score', fn: function(p) { return p.deal_score.toFixed(1); }, compare: 'high', rawFn: function(p) { return p.deal_score; } },
                { label: 'Beds / Baths', fn: function(p) { return p.bedrooms + ' / ' + p.bathrooms; } },
                { label: 'Sqft', fn: function(p) { return p.sqft.toLocaleString(); }, compare: 'high', rawFn: function(p) { return p.sqft; } },
                { label: 'Year Built', fn: function(p) { return String(p.year_built); }, compare: 'high', rawFn: function(p) { return p.year_built; } },
                { label: 'Neighborhood', fn: function(p) { return p.neighborhood_score + '/10'; }, compare: 'high', rawFn: function(p) { return p.neighborhood_score; } },
                { label: 'Auction Date', fn: function(p) { return p.auction_date; } },
                { label: 'Platform', fn: function(p) { return p.auction_platform; } },
                { label: 'Recommended', fn: function(p) { return p.recommended ? 'Yes' : 'No'; } }
            ];

            var headerCells = '<th>Metric</th>';
            props.forEach(function(p) {
                headerCells += '<th>' + p.address.substring(0, 25) + (p.address.length > 25 ? '...' : '') + '</th>';
            });

            var rows = '';
            metrics.forEach(function(m) {
                var bestIdx = -1;
                if (m.compare && props.length > 1) {
                    var rawFn = m.rawFn || function(p) { return parseFloat(m.fn(p).replace(/[$,%]/g, '')); };
                    var vals = props.map(rawFn);
                    if (m.compare === 'high') {
                        bestIdx = vals.indexOf(Math.max.apply(null, vals));
                    } else {
                        bestIdx = vals.indexOf(Math.min.apply(null, vals));
                    }
                }
                rows += '<tr><td class="metric-name">' + m.label + '</td>';
                props.forEach(function(p, i) {
                    var cls = (i === bestIdx) ? ' class="best-value"' : '';
                    rows += '<td' + cls + '>' + m.fn(p) + '</td>';
                });
                rows += '</tr>';
            });

            var backdrop = document.createElement('div');
            backdrop.className = 'comparison-modal-backdrop';
            backdrop.id = 'comparisonModalBackdrop';
            backdrop.onclick = function(e) {
                if (e.target === backdrop) closeComparisonModal();
            };

            backdrop.innerHTML = '<div class="comparison-modal">'
                + '<h2>Property Comparison <button class="close-btn" onclick="closeComparisonModal()">&times;</button></h2>'
                + '<table class="comparison-table"><thead><tr>' + headerCells + '</tr></thead><tbody>' + rows + '</tbody></table>'
                + '</div>';

            document.body.appendChild(backdrop);
        }

        function closeComparisonModal() {
            var backdrop = document.getElementById('comparisonModalBackdrop');
            if (backdrop) backdrop.remove();
        }

        // ─── Auction countdown ───
        function getAuctionCountdown(dateStr) {
            if (!dateStr) return { html: 'N/A', cls: '' };
            var auctionDate = new Date(dateStr + 'T00:00:00');
            var today = new Date();
            today.setHours(0, 0, 0, 0);
            var diff = Math.ceil((auctionDate - today) / (1000 * 60 * 60 * 24));

            if (diff < 0) {
                return { html: 'Passed', cls: 'passed' };
            } else if (diff === 0) {
                return { html: 'TODAY', cls: 'urgent' };
            } else if (diff <= 3) {
                return { html: diff + 'd left', cls: 'urgent' };
            } else if (diff <= 7) {
                return { html: diff + 'd left', cls: 'soon' };
            } else {
                return { html: diff + 'd left', cls: '' };
            }
        }

        // ─── SVG chart rendering ───
        function renderStateChart(properties) {
            var stateCounts = {};
            properties.forEach(function(p) {
                stateCounts[p.state] = (stateCounts[p.state] || 0) + 1;
            });

            var entries = Object.keys(stateCounts).map(function(st) {
                return { state: st, count: stateCounts[st] };
            });
            entries.sort(function(a, b) { return b.count - a.count; });

            if (entries.length === 0) {
                document.getElementById('stateChart').innerHTML = '<p style="color:var(--card-text-muted);text-align:center;padding:20px;">No data</p>';
                return;
            }

            var maxCount = entries[0].count || 1;
            var barHeight = 28;
            var gap = 8;
            var labelWidth = 110;
            var countWidth = 40;
            var chartWidth = 400;
            var svgHeight = entries.length * (barHeight + gap) - gap + 10;

            var svg = '<svg viewBox="0 0 ' + (labelWidth + chartWidth + countWidth + 10) + ' ' + svgHeight + '" xmlns="http://www.w3.org/2000/svg" style="width:100%;height:auto;">';
            svg += '<defs><linearGradient id="stateGrad" x1="0%" y1="0%" x2="100%" y2="0%">';
            svg += '<stop offset="0%" style="stop-color:var(--chart-bar-start, #667eea)"/>';
            svg += '<stop offset="100%" style="stop-color:var(--chart-bar-end, #764ba2)"/>';
            svg += '</linearGradient></defs>';

            entries.forEach(function(e, i) {
                var y = i * (barHeight + gap);
                var barW = (e.count / maxCount) * chartWidth;
                svg += '<text x="' + (labelWidth - 5) + '" y="' + (y + barHeight / 2 + 5) + '" text-anchor="end" fill="var(--chart-label, #555)" font-size="12" font-weight="600">' + e.state + '</text>';
                svg += '<rect x="' + labelWidth + '" y="' + y + '" width="' + barW + '" height="' + barHeight + '" rx="4" fill="url(#stateGrad)" opacity="0.85"/>';
                svg += '<text x="' + (labelWidth + barW + 8) + '" y="' + (y + barHeight / 2 + 5) + '" fill="var(--chart-label, #555)" font-size="12" font-weight="700">' + e.count + '</text>';
            });
            svg += '</svg>';
            document.getElementById('stateChart').innerHTML = svg;
        }

        function updateCharts(properties) {
            if (properties.length > 0) {
                document.getElementById('dataDisclaimer').style.display = 'flex';
                document.getElementById('chartsSection').style.display = 'grid';
                document.getElementById('stateChartSection').style.display = 'grid';
            } else {
                document.getElementById('dataDisclaimer').style.display = 'none';
                document.getElementById('chartsSection').style.display = 'none';
                document.getElementById('stateChartSection').style.display = 'none';
            }
            renderStateChart(properties);
        }

        // ─── CSV export ───
        function exportCSV() {
            if (currentProperties.length === 0) return;

            var headers = [
                'ID', 'Address', 'City', 'State', 'Zip', 'Region',
                'Auction Price', 'Est. ARV', 'Est. Repairs',
                'Profit Potential', 'Profit Margin', 'Deal Score',
                'Bedrooms', 'Bathrooms', 'Sqft', 'Year Built',
                'Neighborhood Score', 'Auction Date', 'Platform',
                'Recommended', 'Foreclosing Entity', 'Total Debt',
                'Loan Type', 'Foreclosure Stage', 'Default Date',
                'Occupancy', 'Condition', 'Property Tax', 'HOA',
                'Est. Monthly Rent', 'Last Sale Price', 'Last Sale Date',
                'Status'
            ];

            function csvEscape(val) {
                if (val === null || val === undefined) return '';
                var s = String(val);
                if (s.indexOf(',') !== -1 || s.indexOf('"') !== -1 || s.indexOf('\n') !== -1) {
                    return '"' + s.replace(/"/g, '""') + '"';
                }
                return s;
            }

            var rows = [headers.join(',')];
            currentProperties.forEach(function(p) {
                var status = getPropertyStatus(p.id);
                rows.push([
                    csvEscape(p.id),
                    csvEscape(p.address),
                    csvEscape(p.city),
                    csvEscape(p.state),
                    csvEscape(p.zip_code),
                    csvEscape(p.region),
                    p.auction_price,
                    p.estimated_arv,
                    p.estimated_repairs,
                    p.profit_potential,
                    p.profit_margin.toFixed(1),
                    p.deal_score.toFixed(1),
                    p.bedrooms,
                    p.bathrooms,
                    p.sqft,
                    p.year_built,
                    p.neighborhood_score,
                    csvEscape(p.auction_date),
                    csvEscape(p.auction_platform),
                    p.recommended ? 'Yes' : 'No',
                    csvEscape(p.foreclosing_entity),
                    p.total_debt || '',
                    csvEscape(p.loan_type),
                    csvEscape(p.foreclosure_stage),
                    csvEscape(p.default_date),
                    csvEscape(p.occupancy_status),
                    csvEscape(p.condition_category),
                    p.annual_property_tax || '',
                    p.hoa_monthly || '',
                    p.estimated_monthly_rent || '',
                    p.last_sale_price || '',
                    csvEscape(p.last_sale_date),
                    csvEscape(status)
                ].join(','));
            });

            var csvContent = rows.join('\n');
            var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            var url = URL.createObjectURL(blob);
            var link = document.createElement('a');
            link.href = url;
            link.download = 'properties_export_' + new Date().toISOString().slice(0, 10) + '.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // ─── Alerts toggle ───
        function toggleAlerts() {
            alertsExpanded = !alertsExpanded;
            displayAlerts(allAlerts);
        }

        // ─── Load data ───
        async function loadData() {
            try {
                const response = await fetch('property_analysis.json');
                const data = await response.json();

                allProperties = data.all_properties;
                currentProperties = [...allProperties];
                allAlerts = data.alerts || [];

                updateStats(data);
                displayAlerts(allAlerts);
                displayProperties(currentProperties);
                updateCharts(currentProperties);
                updateNotesIndicator();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('propertiesContainer').innerHTML =
                    '<div class="no-results"><h3>Error loading data</h3><p>Please run the analyzer first: python3 main.py --mock</p></div>';
            }
        }

        function updateStats(data) {
            document.getElementById('totalProperties').textContent = data.total_properties;
            document.getElementById('recommendedDeals').textContent = data.recommended_deals;
            document.getElementById('avgMargin').textContent = data.avg_profit_margin.toFixed(1) + '%';
            document.getElementById('hotDeals').textContent = data.statistics.deals_over_40_percent;
        }

        function displayAlerts(alerts) {
            if (!alerts || alerts.length === 0) return;

            var section = document.getElementById('alertsSection');
            section.style.display = 'block';
            var container = document.getElementById('alertsContainer');
            var toggleBtn = document.getElementById('alertsToggle');

            // Filter out dismissed alerts
            var dismissed = getDismissedAlerts();
            var activeAlerts = alerts.filter(function(a) { return !dismissed[a.property_id]; });
            var dismissedCount = alerts.length - activeAlerts.length;

            if (activeAlerts.length === 0) {
                container.innerHTML = '<div class="alerts-empty">All alerts reviewed. <button class="restore-alerts-btn" onclick="restoreAllAlerts()">Restore All</button></div>';
                toggleBtn.style.display = 'none';
                return;
            }

            var displayCount = alertsExpanded ? activeAlerts.length : 10;
            var visibleAlerts = activeAlerts.slice(0, displayCount);

            container.innerHTML = visibleAlerts.map(function(alert) {
                var className = 'alert-item';
                if (alert.level.indexOf('EXCELLENT') !== -1) className += ' excellent';
                else if (alert.level.indexOf('GOOD') !== -1) className += ' good';

                return '<div class="' + className + '" onclick="scrollToProperty(\'' + alert.property_id + '\')">'
                    + '<button class="alert-dismiss" onclick="dismissAlert(\'' + alert.property_id + '\', event)" title="Dismiss &mdash; mark as reviewed">&times;</button>'
                    + '<div class="alert-level">' + alert.level + '</div>'
                    + '<div class="alert-address"><strong>' + alert.address + '</strong></div>'
                    + '<div class="alert-details">'
                    + '<div>Profit: <strong>' + alert.profit_potential + '</strong></div>'
                    + '<div>Margin: <strong>' + alert.profit_margin + '</strong></div>'
                    + '<div>Score: <strong>' + alert.deal_score.toFixed(1) + '/100</strong></div>'
                    + '<div>Max Bid: <strong>$' + (alert.max_bid_price || 0).toLocaleString() + '</strong></div>'
                    + '</div>'
                    + '<div class="alert-cta">Click to view full details &rarr;</div>'
                    + '</div>';
            }).join('');

            // Footer: show all / restore dismissed
            var footerHtml = '';
            if (activeAlerts.length > 10) {
                toggleBtn.style.display = 'inline-block';
                toggleBtn.textContent = alertsExpanded ? 'Show Less' : 'Show All (' + activeAlerts.length + ')';
            } else {
                toggleBtn.style.display = 'none';
            }
            if (dismissedCount > 0) {
                var restoreBtn = document.getElementById('restoreAlertsBtn');
                if (!restoreBtn) {
                    restoreBtn = document.createElement('button');
                    restoreBtn.id = 'restoreAlertsBtn';
                    restoreBtn.className = 'alerts-toggle';
                    restoreBtn.onclick = restoreAllAlerts;
                    toggleBtn.parentNode.insertBefore(restoreBtn, toggleBtn.nextSibling);
                }
                restoreBtn.style.display = 'inline-block';
                restoreBtn.textContent = 'Restore ' + dismissedCount + ' Dismissed';
            } else {
                var restoreBtn = document.getElementById('restoreAlertsBtn');
                if (restoreBtn) restoreBtn.style.display = 'none';
            }
        }

        // ─── Foreclosure section renderer ───
        function renderForeclosureSection(prop) {
            if (!prop.foreclosing_entity) return '';
            var bankUrl = prop.bank_contact_url || BANK_CONTACT_URLS[prop.foreclosing_entity] || null;
            var entityHtml = bankUrl
                ? '<a href="' + bankUrl + '" target="_blank" rel="noopener">' + prop.foreclosing_entity + '</a>'
                : prop.foreclosing_entity;
            var debt = prop.total_debt ? '$' + prop.total_debt.toLocaleString() : 'N/A';
            var loanType = prop.loan_type || 'N/A';
            var stage = prop.foreclosure_stage || 'N/A';
            var defaultDate = prop.default_date || 'N/A';
            return '<div class="property-details" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--divider);">'
                + '<div class="detail-item">\u{1F3DB}\uFE0F <strong>' + entityHtml + '</strong></div>'
                + '<div class="detail-item">\u{1F4B0} Debt: ' + debt + '</div>'
                + '<div class="detail-item">\u{1F4CB} ' + loanType + '</div>'
                + '<div class="detail-item">\u2696\uFE0F ' + stage + '</div>'
                + '<div class="detail-item">\u{1F4C5} Default: ' + defaultDate + '</div>'
                + '</div>';
        }

        // ─── Extra data fields renderer ───
        function renderExtraDataRow(prop) {
            var items = [];
            if (prop.occupancy_status) {
                var occIcon = prop.occupancy_status === 'Vacant' ? '\u{1F3DA}\uFE0F' : '\u{1F464}';
                items.push('<div class="detail-item">' + occIcon + ' ' + prop.occupancy_status + '</div>');
            }
            if (prop.condition_category) {
                var condIcon = '\u{1F527}';
                if (prop.condition_category === 'Cosmetic Only') condIcon = '\u{1F3A8}';
                else if (prop.condition_category === 'Heavy Rehab') condIcon = '\u{1F6A7}';
                items.push('<div class="detail-item">' + condIcon + ' ' + prop.condition_category + '</div>');
            }
            if (prop.annual_property_tax) {
                items.push('<div class="detail-item">\u{1F4B5} Tax: $' + prop.annual_property_tax.toLocaleString() + '/yr</div>');
            }
            if (prop.hoa_monthly) {
                items.push('<div class="detail-item">\u{1F3E2} HOA: $' + prop.hoa_monthly.toLocaleString() + '/mo</div>');
            }
            if (prop.estimated_monthly_rent) {
                items.push('<div class="detail-item">\u{1F4B2} Rent: $' + prop.estimated_monthly_rent.toLocaleString() + '/mo</div>');
            }
            if (prop.last_sale_price && prop.last_sale_date) {
                items.push('<div class="detail-item">\u{1F4C8} Last sold: $' + prop.last_sale_price.toLocaleString() + ' (' + prop.last_sale_date + ')</div>');
            } else if (prop.last_sale_price) {
                items.push('<div class="detail-item">\u{1F4C8} Last sold: $' + prop.last_sale_price.toLocaleString() + '</div>');
            }
            if (items.length === 0) return '';
            return '<div class="extra-data-row">' + items.join('') + '</div>';
        }

        // ─── Notes section renderer ───
        function renderNotesSection(prop) {
            var note = getPropertyNote(prop.id);
            return '<div class="property-notes">'
                + '<label>\u{1F4DD} Notes</label>'
                + '<textarea data-prop-id="' + prop.id + '" onchange="handleNoteChange(this)" placeholder="Add private notes...">' + escapeHtml(note) + '</textarea>'
                + '</div>';
        }

        function escapeHtml(text) {
            var div = document.createElement('div');
            div.appendChild(document.createTextNode(text));
            return div.innerHTML;
        }

        // ─── Property card renderer ───
        function displayProperties(properties) {
            var container = document.getElementById('propertiesContainer');
            document.getElementById('propertyCount').textContent = properties.length;

            if (properties.length === 0) {
                container.innerHTML = '<div class="no-results"><h3>No properties match your filters</h3><p>Try adjusting your search criteria</p></div>';
                return;
            }

            container.innerHTML = properties.map(function(prop) {
                var badgeClass = prop.profit_margin >= 40 ? 'hot' : '';
                var badgeText = prop.profit_margin >= 40 ? '\u{1F525} HOT DEAL' :
                                 prop.profit_margin >= 35 ? '\u2B50 EXCELLENT' :
                                 prop.recommended ? '\u2705 GOOD' : '\u{1F4CA} ' + prop.deal_score.toFixed(0);

                var currentStatus = getPropertyStatus(prop.id);
                var statusClass = currentStatus === 'interested' ? ' interested' :
                                    currentStatus === 'not_interested' ? ' not-interested' : '';

                var auctionUrl = prop.property_url || PLATFORM_URLS[prop.auction_platform] || null;
                var linkLabel = auctionUrl && auctionUrl.indexOf('zillow.com') !== -1
                    ? 'View on Zillow' : prop.auction_platform;
                var platformHtml = auctionUrl
                    ? '<a href="' + auctionUrl + '" target="_blank" rel="noopener">' + linkLabel + '</a>'
                    + ' <span style="opacity:0.6;font-size:0.85em;">(' + prop.auction_platform + ')</span>'
                    : prop.auction_platform;

                var countdown = getAuctionCountdown(prop.auction_date);
                var countdownHtml = '<span class="auction-countdown ' + countdown.cls + '">' + countdown.html + '</span>';

                var isCompared = comparisonSet.has(prop.id);

                return '<div class="property-card ' + (prop.recommended ? 'recommended' : '') + '" id="' + prop.id + '">'
                    + '<div class="property-header">'
                    + '<input type="checkbox" class="compare-checkbox" data-prop-id="' + prop.id + '" ' + (isCompared ? 'checked' : '') + ' onchange="toggleCompare(this, \'' + prop.id + '\')" title="Select for comparison">'
                    + '<div class="property-address">'
                    + '<h3>' + prop.address + '</h3>'
                    + '<p>' + prop.city + ', ' + prop.state + ' ' + prop.zip_code + (prop.region ? ' &mdash; ' + prop.region : '') + '</p>'
                    + '</div>'
                    + '<select class="status-select' + statusClass + '" data-prop-id="' + prop.id + '" onchange="handleStatusChange(this)">'
                    + '<option value="not_reviewed"' + (currentStatus === 'not_reviewed' ? ' selected' : '') + '>-- Not Reviewed --</option>'
                    + '<option value="interested"' + (currentStatus === 'interested' ? ' selected' : '') + '>\u2B50 Interested</option>'
                    + '<option value="not_interested"' + (currentStatus === 'not_interested' ? ' selected' : '') + '>\u2717 Not Interested</option>'
                    + '</select>'
                    + '<div class="deal-badge ' + badgeClass + '">' + badgeText + '</div>'
                    + '</div>'
                    + '<div class="property-metrics">'
                    + '<div class="metric"><div class="metric-label">Last Sale Price</div><div class="metric-value">$' + prop.auction_price.toLocaleString() + '</div></div>'
                    + '<div class="metric"><div class="metric-label">Est. ARV</div><div class="metric-value">$' + prop.estimated_arv.toLocaleString() + '</div></div>'
                    + '<div class="metric"><div class="metric-label">Est. Repairs</div><div class="metric-value">$' + prop.estimated_repairs.toLocaleString() + '</div></div>'
                    + '<div class="metric"><div class="metric-label">Max Bid (91% Rule)</div><div class="metric-value max-bid ' + (prop.auction_price <= (prop.max_bid_price || 0) ? 'under-max' : 'over-max') + '">$' + (prop.max_bid_price || 0).toLocaleString() + '</div></div>'
                    + '<div class="metric"><div class="metric-label">Profit Potential</div><div class="metric-value profit">$' + prop.profit_potential.toLocaleString() + '</div></div>'
                    + '<div class="metric"><div class="metric-label">Profit Margin</div><div class="metric-value profit">' + prop.profit_margin.toFixed(1) + '%</div></div>'
                    + '<div class="metric"><div class="metric-label">Deal Score</div><div class="metric-value">' + prop.deal_score.toFixed(1) + '/100</div><div class="progress-bar"><div class="progress-fill" style="width: ' + prop.deal_score + '%"></div></div></div>'
                    + '</div>'
                    + '<div class="property-details">'
                    + '<div class="detail-item">\u{1F6CF}\uFE0F ' + prop.bedrooms + ' bed</div>'
                    + '<div class="detail-item">\u{1F6C1} ' + prop.bathrooms + ' bath</div>'
                    + '<div class="detail-item">\u{1F4CF} ' + prop.sqft.toLocaleString() + ' sqft</div>'
                    + '<div class="detail-item">\u{1F4C5} Built ' + prop.year_built + '</div>'
                    + '<div class="detail-item">\u{1F3D8}\uFE0F Score: ' + prop.neighborhood_score + '/10</div>'
                    + '<div class="detail-item">\u{1F3E6} ' + platformHtml + '</div>'
                    + '</div>'
                    + renderExtraDataRow(prop)
                    + renderForeclosureSection(prop)
                    + renderNotesSection(prop)
                    + '</div>';
            }).join('');
        }

        // ─── Filter logic ───
        function applyFilters() {
            var state = document.getElementById('stateFilter').value;
            var minMargin = parseFloat(document.getElementById('minMargin').value) || 0;
            var minAuctionPrice = parseFloat(document.getElementById('minPrice').value) || 0;
            var maxAuctionPrice = parseFloat(document.getElementById('maxPrice').value) || 2000000;
            var minScore = parseFloat(document.getElementById('minScore').value) || 0;
            var sortBy = document.getElementById('sortBy').value;
            var statusFilter = document.getElementById('statusFilter').value;
            var searchTerm = (document.getElementById('searchInput').value || '').toLowerCase().trim();

            currentProperties = allProperties.filter(function(prop) {
                if (state !== 'all' && prop.state !== state) return false;
                if (selectedRegions.length > 0 && selectedRegions.indexOf(prop.region) === -1) return false;
                if (prop.profit_margin < minMargin) return false;
                if (prop.auction_price < minAuctionPrice || prop.auction_price > maxAuctionPrice) return false;
                if (prop.deal_score < minScore) return false;
                if (statusFilter !== 'all') {
                    var propStatus = getPropertyStatus(prop.id);
                    if (propStatus !== statusFilter) return false;
                }
                if (searchTerm) {
                    var haystack = (
                        (prop.address || '') + ' ' +
                        (prop.city || '') + ' ' +
                        (prop.id || '') + ' ' +
                        (prop.foreclosing_entity || '')
                    ).toLowerCase();
                    if (haystack.indexOf(searchTerm) === -1) return false;
                }
                return true;
            });

            currentProperties.sort(function(a, b) {
                if (sortBy === 'auction_date') {
                    return new Date(a.auction_date) - new Date(b.auction_date);
                }
                return b[sortBy] - a[sortBy];
            });

            displayProperties(currentProperties);
            updateCharts(currentProperties);
        }

        function scrollToProperty(id) {
            var element = document.getElementById(id);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                element.style.animation = 'pulse 1s';
                setTimeout(function() { element.style.animation = ''; }, 1000);
            }
        }

        // Initialize — only load data if already authed
        var _appInitialized = false;
        function initApp() {
            if (_appInitialized) return;
            _appInitialized = true;
            loadData();
        }

        if (sessionStorage.getItem('authed') === '1') {
            document.getElementById('mainContent').style.display = 'block';
            initApp();
        }
    </script>
    </div><!-- /mainContent -->
</body>
</html>
